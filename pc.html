<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrale Operativa 118</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body, html { height: 100%; margin: 0; overflow: hidden; background-color: #f8f9fa; }
        #main-container { display: flex; height: 100vh; flex-direction: column; }
        
        /* Barra Superiore */
        .top-bar { background-color: #dc3545; padding: 10px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        
        /* Area Mappe */
        .map-wrapper { flex-grow: 1; position: relative; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* Controlli Mappa */
        .map-controls { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 998; }
        .btn-map-switch { width: 60px; height: 60px; border-radius: 12px; font-size: 24px; border: 2px solid #ccc; background: rgba(255,255,255,0.95); transition: 0.2s; }
        .btn-map-switch:hover { transform: scale(1.05); }
        .btn-map-switch.active { border-color: #0d6efd; background-color: #e7f1ff; color: #0d6efd; }

        /* Container Tracking Live */
        #trackingContainer {
            display: none; 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: white; z-index: 2000;
        }
    </style>
</head>
<body>

<div id="main-container">
    <div class="top-bar d-flex align-items-center gap-3">
        <div class="fw-bold fs-4 d-none d-md-block"><i class="fa-solid fa-laptop-medical"></i> 118</div>
        
        <div class="input-group flex-grow-1">
            <input type="text" id="inputAddress" class="form-control fs-5" placeholder="Inserisci indirizzo..." value="Ospedale di Stato, San Marino">
            
            <button class="btn btn-warning fw-bold" onclick="updateLocalMap()">
                <i class="fa-solid fa-magnifying-glass"></i> Cerca Qui
            </button>
            
            <button class="btn btn-light fw-bold text-danger px-4" id="btnSend">
                <i class="fa-solid fa-tower-broadcast"></i> INVIA AL TABLET
            </button>
        </div>

        <button class="btn btn-info fw-bold text-white border border-white" onclick="toggleTrackingMap()">
            <i class="fa-solid fa-location-crosshairs"></i> DOV'È L'AMBULANZA?
        </button>
    </div>

    <div class="map-wrapper">
        <button class="btn btn-dark position-absolute top-0 start-0 m-3 shadow" style="z-index:999" data-bs-toggle="modal" data-bs-target="#ipaModal">
            <i class="fa-solid fa-file-contract"></i> Dati IPA
        </button>

        <iframe id="mapFrame" src="about:blank"></iframe>

        <div class="map-controls">
            <button class="btn btn-map-switch active" onclick="switchMap('google')" title="Google Maps"><i class="fa-brands fa-google"></i></button>
            <button class="btn btn-map-switch" onclick="switchMap('ps2')" title="Pronto Soccorso"><i class="fa-solid fa-hospital"></i></button>
            <button class="btn btn-map-switch" onclick="switchMap('sentieri')" title="Sentieri"><i class="fa-solid fa-tree"></i></button>
        </div>

        <div id="trackingContainer">
            <button class="btn btn-danger position-absolute top-0 end-0 m-3 shadow" style="z-index:9999" onclick="toggleTrackingMap()">
                <i class="fa-solid fa-xmark"></i> CHIUDI TRACCIAMENTO
            </button>
            <div id="liveMap" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="ipaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Archivio IPA</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control font-monospace" rows="15" placeholder="Incolla qui il contenuto del file IPA..."></textarea>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAu-Ow4yjxPCfw7SqqEAO1RyxB5cuB1TD0",
      authDomain: "mappa-118.firebaseapp.com",
      databaseURL: "https://mappa-118-default-rtdb.firebaseio.com",
      projectId: "mappa-118",
      storageBucket: "mappa-118.firebasestorage.app",
      messagingSenderId: "435041812031",
      appId: "1:435041812031:web:d7ecb90ec4f25e133a028a",
      measurementId: "G-0MH2GS1N4L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 1. INVIO MISSIONE ---
    document.getElementById('btnSend').addEventListener('click', () => {
        const address = document.getElementById('inputAddress').value;
        if(!address) return alert("Inserisci un indirizzo valido!");

        const btn = document.getElementById('btnSend');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Invio...';

        set(ref(db, 'current_mission'), {
            address: address,
            timestamp: Date.now(),
            sender: "Centrale"
        }).then(() => {
            alert("✅ Missione inviata al Tablet!");
            btn.innerHTML = oldText;
        }).catch(err => {
            alert("Errore: " + err.message);
            btn.innerHTML = oldText;
        });
    });

    // --- 2. TRACCIAMENTO LIVE (Leaflet) ---
    let map = null;
    let marker = null;

    window.toggleTrackingMap = function() {
        const container = document.getElementById('trackingContainer');
        if (container.style.display === 'none' || container.style.display === '') {
            container.style.display = 'block';
            if (!map) initMap();
        } else {
            container.style.display = 'none';
        }
    };

    function initMap() {
        // Centra su San Marino
        map = L.map('liveMap').setView([43.93, 12.45], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        const ambulanceIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2636/2636280.png', // Icona
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20]
        });

        marker = L.marker([43.93, 12.45], {icon: ambulanceIcon}).addTo(map);
        marker.bindPopup("In attesa segnale GPS...").openPopup();

        // Ascolta posizione da Firebase
        onValue(ref(db, 'ambulance_location'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const latLng = [data.lat, data.lng];
                marker.setLatLng(latLng);
                marker.bindPopup(`<b>Ambulanza</b><br>Velocità: ${data.speed} km/h<br>Aggiornato: ${new Date(data.timestamp).toLocaleTimeString()}`).openPopup();
                map.panTo(latLng); // Segue l'ambulanza
            }
        });
    }
</script>

<script>
    // --- GESTIONE MAPPE STATICHE ---
    // URL per iframe (Google embed standard)
    const maps = {
        google: "https://maps.google.com/maps?t=&z=15&ie=UTF8&iwloc=&output=embed&q=",
        ps2: "https://mappeonline.pa.sm/maps/prontosoccorso2/",
        sentieri: "https://mappeonline.pa.sm/maps/sentierimobile/"
    };
    let currentMap = 'google';

    function updateLocalMap() {
        const addr = document.getElementById('inputAddress').value;
        const frame = document.getElementById('mapFrame');
        
        if(currentMap === 'google') {
            frame.src = maps.google + encodeURIComponent(addr);
        } else {
            frame.src = maps[currentMap];
        }
    }
    
    function switchMap(type) {
        currentMap = type;
        document.querySelectorAll('.btn-map-switch').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        updateLocalMap();
    }
    
    window.onload = updateLocalMap;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>